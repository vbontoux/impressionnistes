# Lambda Layer Source Files Rule

## Purpose
Prevent editing Lambda layer files directly. Always edit source files that get copied to the layer during build.

## Critical Rule

**NEVER edit files in `functions/layer/python/` directly!**

These files are GENERATED by the build script and will be overwritten on the next build.

## Correct Workflow

### Source Files Location
All Lambda layer Python code lives in: `functions/shared/`

### Build Process
The build script `functions/build-layer.sh` does:
1. Installs dependencies from `functions/shared/requirements.txt` to `functions/layer/python/`
2. Copies all `.py` files (except `__init__.py`) from `functions/shared/` to `functions/layer/python/`

### When Making Changes

**‚úÖ CORRECT:**
1. Edit files in `functions/shared/`
2. Run build script: `cd functions && ./build-layer.sh`
3. Deploy: `cd infrastructure && make deploy-dev`

**‚ùå WRONG:**
1. Edit files in `functions/layer/python/` directly
2. Deploy
3. Changes get overwritten on next build

## Files Affected

All shared utility files:
- `functions/shared/payment_formatters.py` ‚Üí `functions/layer/python/payment_formatters.py`
- `functions/shared/payment_calculations.py` ‚Üí `functions/layer/python/payment_calculations.py`
- `functions/shared/payment_queries.py` ‚Üí `functions/layer/python/payment_queries.py`
- `functions/shared/database.py` ‚Üí `functions/layer/python/database.py`
- `functions/shared/responses.py` ‚Üí `functions/layer/python/responses.py`
- `functions/shared/auth_utils.py` ‚Üí `functions/layer/python/auth_utils.py`
- `functions/shared/access_control.py` ‚Üí `functions/layer/python/access_control.py`
- And all other `.py` files in `functions/shared/`

## How to Identify Source vs Generated

**Source files (edit these):**
- Location: `functions/shared/*.py`
- Purpose: Original source code
- Version control: Committed to git

**Generated files (don't edit):**
- Location: `functions/layer/python/*.py`
- Purpose: Deployed to AWS Lambda layer
- Version control: Should be in `.gitignore` (but currently committed)

## Deployment Process

After editing source files in `functions/shared/`:

```bash
# 1. Rebuild the Lambda layer
cd functions
./build-layer.sh

# 2. Deploy backend (includes layer)
cd ../infrastructure
make deploy-dev
```

The CDK deployment automatically packages `functions/layer/` and uploads it as a Lambda layer.

## Red Flags

üö© Editing any file in `functions/layer/python/`
üö© Seeing different timestamps between `functions/shared/file.py` and `functions/layer/python/file.py`
üö© Changes not appearing after deployment (probably edited wrong file)
üö© Changes disappearing after running build script (edited generated file)

## Quick Check

Before editing a Python utility file, ask:
- **Is this file in `functions/shared/`?** ‚Üí ‚úÖ Edit it
- **Is this file in `functions/layer/python/`?** ‚Üí ‚ùå Find the source in `functions/shared/` instead

## Exception

The ONLY files that should be edited in `functions/layer/` are:
- `functions/layer/requirements.txt` - Layer dependencies (but this should match `functions/shared/requirements.txt`)

Everything else in `functions/layer/python/` is generated.
